<!DOCTYPE html>
<html lang="en">
<head>
<title>OpenVPN Admin</title>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<style type="text/css">
a {
	color: inherit;
	font: inherit;
	text-decoration: none;
}
a:hover {
	color: #06c;
}
body {
	color: #222;
	font: 500 12pt/20px Calibri, sans-serif;
}
body > div {
	padding: 5px;
}
body > div > a {
	color: #cce5ff;
	background-color: #2966a3;
	display: inline-block;
	text-align: center;
	padding: 5px;
	width: 8.3%;
}
body > div > a:hover {
	color: #fff;
	background-color: #337fcc;
}
table {
	table-layout: fixed;
	border-collapse: collapse;
	width: 100%;
}
th {
	text-align: left;
	padding: 5px 10px;
}
td {
	border: solid #ddd;
	border-width: 1px 0;
	padding: 5px 10px;
}
tr:hover > td {
	background-color: #ffa;
}
.crit {
	color: #828282;
	background-color: #f2f2f2;
}
.warn {
	color: #ec8b13;
	background-color: #f7efde;
}

</style>
</head>
<body>
<h2>OpenVPN admin</h2>
<div><a id="a0" href="#new">Add new</a></div>
<table id="t0" width="100%">
<colgroup>
<col>
<col>
<col width="25%">
<col>
<col>
<col width="25%">
<col>
<col>
</colgroup>
<thead>
<tr>
<th>Login</th>
<th>Get</th>
<th>Xtra</th>
<th>IP</th>
<th>Time</th>
<th>TX / RX</th>
<th>Control</th>
<th>Validity</th>
</tr>
</thead>
<tbody>
</tbody>
</table>
</body>

<script type="text/javascript">
var a0 = document.getElementById( 'a0' );
var t0 = document.getElementById( 't0' );

a0.addEventListener( 'click', e => {
	let v = window.prompt( 'Enter certificate CN', '' );
	if ( v ) {
		fetch( '/cert.cgi/' + v, { method: 'POST' } )
		.then( r => r.json() )
		.then( r => {
			location.reload();
		} );
	}
	e.preventDefault();
	return false;
} );

function setValidity( row, timestamp ) {
	let val = new Date( timestamp * 1000 );
	row.cells[7].innerHTML = [ new String( val.getFullYear() ), new String( val.getMonth() + 101 ).substring( 1 ), new String( val.getDate() + 100 ).substring( 1 ) ].join( '-' );
	val = val.getTime() - Date.now();
	if ( val < 0 ) {
		row.className = 'crit';
	} else if ( val < 7000 * 86400 ) {
		row.className = 'warn';
	} else {
		row.className = '';
	}

}

fetch( '/user.cgi/' )
.then( r => r.json() )
.then( r => {
	let now = Math.floor( Date.now() / 1000 );
	let el;
	for ( let i in r ) {
		let row = t0.tBodies[0].insertRow();
		for ( let j = 0; j < 8; j++ ) row.insertCell();
		
		row.dataset.name = i;
		
		el = document.createElement('div');
		el.innerHTML = i;
		row.cells[0].appendChild( el );
		
		el = document.createElement('a');
		el.href = '/cert.cgi/' + i;
		el.download = i + '.ovpn';
		el.innerHTML = 'Download';
		row.cells[1].appendChild( el );

		el = document.createElement('a');
		el.href = '/cert.cgi/' + i;
		el.innerHTML = 'New';
		
		el.addEventListener( 'click', e => {
			if ( window.confirm( 'Issuing new certificate "' + i + '". Current one will be valid until expiration date' ) ) {
				fetch( '/cert.cgi/' + i, { method: 'POST' } )
				.then( r => r.json() )
				.then( r => {
					setValidity( row, r[1] );
				} );
			}
			e.preventDefault();
			return false;
		} );
		row.cells[2].appendChild( el );

		el = document.createElement('span');
		el.innerHTML = ' | ';
		row.cells[2].appendChild( el );

		el = document.createElement('a');
		el.href = '/cert.cgi/' + i;
		el.innerHTML = 'Replace';
		el.addEventListener( 'click', e => {
			if ( window.confirm( 'Issuing new certificate "' + i + '". Current one will be revoked' ) ) {
				fetch( '/cert.cgi/' + i, { method: 'PUT' } )
				.then( r => r.json() )
				.then( r => {
					setValidity( row, r[1] );
				} );
			}
			e.preventDefault();
			return false;
		} );
		row.cells[2].appendChild( el );

		el = document.createElement('span');
		el.innerHTML = ' | ';
		row.cells[2].appendChild( el );

		el = document.createElement('a');
		el.href = '/cert.cgi/' + i;
		el.innerHTML = 'Revoke';
		el.addEventListener( 'click', e => {
			if ( window.confirm( 'Revoking certificate "' + i + '". Double check this action' ) ) {
				fetch( '/cert.cgi/' + i, { method: 'DELETE' } )
				.then( r => {
					location.reload();
				} );
			}
			e.preventDefault();
			return false;
		} );
		row.cells[2].appendChild( el );

		for ( let j in r[i] ) {
			let time = now - r[i][j].time;
			let unit = 'second';
			let tx = Math.round( Math.log( r[i][j].tx / 1000000 + 1 ) * 10 );
			let rx = Math.round( Math.log( r[i][j].rx / 1000000 + 1 ) * 10 );
			
			el = document.createElement('span');
			el.innerHTML = r[i][j].ip;
			row.cells[3].appendChild( el );
			
			[[60,'minute'], [60,'hour'], [24,'day']].every( t => {
				if ( time > t[0] ) {
					time = Math.round( time / t[0] );
					unit = t[1];
					return true;
				}
			} );
			if ( time !== 1 ) unit += 's';
			row.cells[4].innerHTML = time + ' ' + unit;
			
			unit = 'b';
			['K', 'M', 'G'].every( t => {
				if ( ( r[i][j].tx > 1024 ) && ( r[i][j].rx > 1024 ) ) {
					r[i][j].tx = Math.round( r[i][j].tx / 1024 );
					r[i][j].rx = Math.round( r[i][j].rx / 1024 );
					unit = t;
					return true;
				}
			});
			row.cells[5].style = 'background-image: url(/admin/progress.cgi?tx=' + tx + '&rx=' + rx + ');';
			row.cells[5].title = r[i][j].tx + unit + ' / ' + r[i][j].rx + unit;
			
			el = document.createElement('a');
			el.href = '/user.cgi/' + j;
			el.innerHTML = 'Kick';
			el.addEventListener( 'click', e => {
				if ( window.confirm( 'About to kick user "' + i + '". Confirm?' ) ) {
					fetch( '/user.cgi/' + j, { method: 'DELETE' } );
				}
				e.preventDefault();
				return false;
			} );
			row.cells[6].appendChild( el );

			break;
		}
	}
	fetch( '/cert.cgi/' )
	.then( r => r.json() )
	.then( r => {
		let j = 0;
		let el;
		for ( let i in r ) {
			if ( t0.tBodies[0].rows[j].dataset.name == i ) {
				setValidity( t0.tBodies[0].rows[j], r[i][1] );
			}
			j++;
		}
	} );
 } );


</script>
</html>
